!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("deep-clone-simple"),require("object-bystring")):"function"==typeof define&&define.amd?define(["deep-clone-simple","object-bystring"],e):(t=t||self).substate=e(t.deepclone,t.byString)}(this,(function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e;var s="UPDATE_STATE",f="CHANGE_STATE";return function(r){function c(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n(this,c),(t=function(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?u(t):e}(this,i(c).call(this))).name=e.name||"SubStateInstance",t.afterUpdate=e.afterUpdate||[],t.beforeUpdate=e.beforeUpdate||[],t.currentState=e.currentState||0,t.stateStorage=e.stateStorage||[],t.defaultDeep=e.defaultDeep||!1,e.state&&t.stateStorage.push(e.state),t.on(s,t.updateState.bind(u(t))),t.on(f,t.changeState.bind(u(t))),t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}(c,r),a(c,[{key:"getState",value:function(t){return this.stateStorage[t]}},{key:"getCurrentState",value:function(t){return this.getState(this.currentState)}},{key:"getProp",value:function(t){return e(this.getCurrentState(),t)}},{key:"changeState",value:function(t){this.currentState=t.requestedState,this.emit(t.$type||"STATE_CHANGED",this.getCurrentState())}},{key:"resetState",value:function(){this.currentState=0,this.stateStorage=[this.stateStorage[0]],this.emit("STATE_RESET")}},{key:"pushState",value:function(t){this.stateStorage.push(t),this.currentState=this.stateStorage.length-1}},{key:"updateState",value:function(n){var r,a=this;for(var i in this.beforeUpdate.length>0&&this.beforeUpdate.forEach((function(t){return t(a,n)})),r=n.$deep||this.defaultDeep?t(this.getCurrentState()):Object.assign({},this.getCurrentState()),n)n.hasOwnProperty(i)&&e(r,i,n[i]);!this.defaultDeep&&(r.$deep=!1),n.$type||(r.$type=s),this.pushState(r),this.afterUpdate.length>0&&this.afterUpdate.forEach((function(t){return t(a)})),this.emit(n.$type||"STATE_UPDATED",this.getCurrentState())}}]),c}(function(){function t(){n(this,t),this.events={}}return a(t,[{key:"on",value:function(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)}},{key:"off",value:function(t,e){if(this.events[t])for(var n=0;n<this.events[t].length;n++)if(this.events[t][n]===e){this.events[t].splice(n,1);break}}},{key:"emit",value:function(t,e){this.events[t]&&this.events[t].forEach((function(t,n){t(e)}))}}]),t}())}));

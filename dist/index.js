!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("deep-clone-simple"),require("object-bystring")):"function"==typeof define&&define.amd?define(["deep-clone-simple","object-bystring"],e):(t=t||self).substate=e(t.deepclone,t.byString)}(this,(function(t,e){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e;class s{constructor(){this.events={}}on(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)}off(t,e){if(this.events[t])for(var s=0;s<this.events[t].length;s++)if(this.events[t][s]===e){this.events[t].splice(s,1);break}}emit(t,e){this.events[t]&&this.events[t].forEach((function(t,s){t(e)}))}}const a="UPDATE_STATE";return class extends s{constructor(t={}){super(),this.name=t.name||"SubStateInstance",this.afterUpdate=t.afterUpdate||[],this.beforeUpdate=t.beforeUpdate||[],this.currentState=t.currentState||0,this.stateStorage=t.stateStorage||[],this.defaultDeep=t.defaultDeep||!1,t.state&&this.stateStorage.push(t.state),this.on(a,this.updateState.bind(this))}getState(t){return this.stateStorage[t]}getCurrentState(t){return this.getState(this.currentState)}getProp(t){return e(this.getCurrentState(),t)}changeState(t){this.currentState=t.requestedState,this.emit(t.$type||"STATE_CHANGED",this.getCurrentState())}resetState(){this.currentState=0,this.stateStorage=[this.stateStorage[0]],this.emit("STATE_RESET")}pushState(t){this.stateStorage.push(t),this.currentState=this.stateStorage.length-1}updateState(s){let r;this.beforeUpdate.length>0&&this.beforeUpdate.forEach(t=>t(this,s)),r=s.$deep||this.defaultDeep?t(this.getCurrentState()):Object.assign({},this.getCurrentState());for(let t in s)s.hasOwnProperty(t)&&e(r,t,s[t]);!this.defaultDeep&&(r.$deep=!1),s.$type||(r.$type=a),this.pushState(r),this.afterUpdate.length>0&&this.afterUpdate.forEach(t=>t(this)),this.emit(s.$type||"STATE_UPDATED",this.getCurrentState())}}}));
